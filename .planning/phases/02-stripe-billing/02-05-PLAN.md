---
phase: 02-stripe-billing
plan: 05
type: execute
wave: 3
depends_on: ["02-03", "02-04"]
files_modified:
  - lib/actions/stripe.ts
  - app/dashboard/layout.tsx
  - app/dashboard/billing/page.tsx
  - components/trial-badge.tsx
  - app/blocked/page.tsx
  - proxy.ts
autonomous: true

must_haves:
  truths:
    - "Dashboard layout checks subscription and shows trial badge"
    - "User sees trial countdown as 'Trial: Xd' badge in header"
    - "User in grace period sees 'Renove em Xd' warning badge"
    - "User can access billing page to see subscription status"
    - "User can click to access Stripe Customer Portal"
    - "Blocked user sees friendly block screen with subscribe option"
    - "Blocked user cannot access dashboard routes"
  artifacts:
    - path: "components/trial-badge.tsx"
      provides: "Trial/grace countdown badge component"
      min_lines: 30
    - path: "app/dashboard/billing/page.tsx"
      provides: "Subscription status and portal access page"
      min_lines: 60
    - path: "app/blocked/page.tsx"
      provides: "Friendly block screen for expired subscriptions"
      min_lines: 40
  key_links:
    - from: "app/dashboard/layout.tsx"
      to: "lib/subscription.ts"
      via: "getSubscriptionStatus call"
      pattern: "getSubscriptionStatus"
    - from: "app/dashboard/billing/page.tsx"
      to: "lib/actions/stripe.ts"
      via: "redirectToCustomerPortal action"
      pattern: "redirectToCustomerPortal"
---

<objective>
Implement subscription gating, trial badge display, billing page, and block screen.

Purpose: Users need visual feedback about their subscription status (trial countdown, grace period warning) and a way to manage their subscription via Stripe Customer Portal. Users with expired subscriptions must be blocked from dashboard access.

Output: Complete subscription UI with trial badge, billing page, Customer Portal access, and block screen.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-stripe-billing/02-CONTEXT.md
@.planning/phases/02-stripe-billing/02-RESEARCH.md
@lib/subscription.ts (from 02-04)
@app/dashboard/layout.tsx
@proxy.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create trial badge component</name>
  <files>components/trial-badge.tsx</files>
  <action>
Create reusable badge component showing trial or grace period countdown:

```typescript
'use client'

import { Badge } from '@/components/ui/badge'
import { Clock, AlertTriangle } from 'lucide-react'
import type { SubscriptionStatus } from '@/lib/subscription'

interface TrialBadgeProps {
  status: SubscriptionStatus
  daysRemaining: number | null
}

export function TrialBadge({ status, daysRemaining }: TrialBadgeProps) {
  if (status === 'active' || status === 'none' || status === 'blocked') {
    return null
  }

  const isUrgent = daysRemaining !== null && daysRemaining <= 3
  const isGrace = status === 'grace_period'

  const label = isGrace
    ? `Renove em ${daysRemaining}d`
    : `Trial: ${daysRemaining}d`

  const Icon = isGrace ? AlertTriangle : Clock

  return (
    <Badge
      variant={isUrgent || isGrace ? 'destructive' : 'secondary'}
      className="gap-1 text-xs"
    >
      <Icon className="h-3 w-3" />
      {label}
    </Badge>
  )
}
```
  </action>
  <verify>
File exists at components/trial-badge.tsx.
TypeScript compiles without errors.
  </verify>
  <done>
Trial badge component created with trial and grace period states.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add Customer Portal action and update dashboard layout</name>
  <files>lib/actions/stripe.ts, app/dashboard/layout.tsx</files>
  <action>
**Add to lib/actions/stripe.ts:**

```typescript
export async function redirectToCustomerPortal() {
  const supabase = await createClient()
  const { data: { user } } = await supabase.auth.getUser()

  if (!user) throw new Error('Voce precisa estar logado')

  const { data: customer } = await supabase
    .from('customers')
    .select('stripe_customer_id')
    .eq('id', user.id)
    .single()

  if (!customer?.stripe_customer_id) {
    throw new Error('Nenhuma assinatura encontrada')
  }

  const session = await stripe.billingPortal.sessions.create({
    customer: customer.stripe_customer_id,
    return_url: `${process.env.NEXT_PUBLIC_APP_URL}/dashboard/billing`,
  })

  redirect(session.url)
}
```

**Update app/dashboard/layout.tsx:**
Add subscription check and trial badge to header:

```typescript
import { createClient } from "@/lib/supabase/server"
import { redirect } from "next/navigation"
import { LogoutButton } from "./logout-button"
import { TrialBadge } from "@/components/trial-badge"
import { getSubscriptionStatus } from "@/lib/subscription"

export default async function DashboardLayout({
  children,
}: {
  children: React.ReactNode
}) {
  const supabase = await createClient()
  const { data: { user } } = await supabase.auth.getUser()

  if (!user) {
    redirect("/login")
  }

  // Check subscription status
  const subscriptionInfo = await getSubscriptionStatus(user.id)

  // If blocked, redirect to block screen
  if (subscriptionInfo.status === 'blocked') {
    redirect("/blocked")
  }

  // If no subscription at all, redirect to checkout
  if (subscriptionInfo.status === 'none') {
    redirect("/checkout")
  }

  return (
    <div className="min-h-screen bg-background">
      <header className="border-b">
        <div className="container flex h-16 items-center justify-between px-4">
          <div className="flex items-center gap-2">
            <div className="w-8 h-8 bg-primary rounded-lg flex items-center justify-center">
              <span className="text-primary-foreground font-bold text-sm">SG</span>
            </div>
            <span className="font-semibold">Sincron Grupos</span>
          </div>
          <div className="flex items-center gap-4">
            <TrialBadge
              status={subscriptionInfo.status}
              daysRemaining={subscriptionInfo.daysRemaining}
            />
            <span className="text-sm text-muted-foreground">{user.email}</span>
            <LogoutButton />
          </div>
        </div>
      </header>
      <main className="container py-6 px-4">
        {children}
      </main>
    </div>
  )
}
```
  </action>
  <verify>
Dashboard layout compiles without errors.
TrialBadge imported and rendered.
Blocked users redirect to /blocked.
  </verify>
  <done>
Dashboard layout checks subscription and displays trial badge. Blocked users redirected.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create billing page and block screen</name>
  <files>app/dashboard/billing/page.tsx, app/blocked/page.tsx, proxy.ts</files>
  <action>
**Create app/dashboard/billing/page.tsx:**

```typescript
import { createClient } from "@/lib/supabase/server"
import { redirect } from "next/navigation"
import { getSubscriptionStatus } from "@/lib/subscription"
import { redirectToCustomerPortal } from "@/lib/actions/stripe"
import { Button } from "@/components/ui/button"
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from "@/components/ui/card"
import { Badge } from "@/components/ui/badge"
import { CreditCard, ExternalLink } from "lucide-react"

export default async function BillingPage() {
  const supabase = await createClient()
  const { data: { user } } = await supabase.auth.getUser()

  if (!user) {
    redirect("/login")
  }

  const subscriptionInfo = await getSubscriptionStatus(user.id)

  const statusLabels: Record<string, { label: string; variant: "default" | "secondary" | "destructive" }> = {
    active: { label: "Ativo", variant: "default" },
    trialing: { label: "Trial", variant: "secondary" },
    grace_period: { label: "Carencia", variant: "destructive" },
    blocked: { label: "Bloqueado", variant: "destructive" },
    none: { label: "Sem assinatura", variant: "secondary" },
  }

  const currentStatus = statusLabels[subscriptionInfo.status]

  return (
    <div className="max-w-2xl mx-auto space-y-6">
      <div>
        <h1 className="text-2xl font-bold">Assinatura</h1>
        <p className="text-muted-foreground">Gerencie sua assinatura e forma de pagamento</p>
      </div>

      <Card>
        <CardHeader>
          <CardTitle className="flex items-center gap-2">
            <CreditCard className="h-5 w-5" />
            Status da Assinatura
          </CardTitle>
          <CardDescription>
            Informacoes sobre sua assinatura atual
          </CardDescription>
        </CardHeader>
        <CardContent className="space-y-4">
          <div className="flex items-center justify-between">
            <span className="text-sm text-muted-foreground">Status</span>
            <Badge variant={currentStatus.variant}>{currentStatus.label}</Badge>
          </div>

          {subscriptionInfo.daysRemaining !== null && (
            <div className="flex items-center justify-between">
              <span className="text-sm text-muted-foreground">
                {subscriptionInfo.status === 'trialing' ? 'Dias restantes do trial' : 'Dias para renovar'}
              </span>
              <span className="font-medium">{subscriptionInfo.daysRemaining} dias</span>
            </div>
          )}

          <div className="pt-4 border-t">
            <form action={redirectToCustomerPortal}>
              <Button type="submit" variant="outline" className="w-full">
                <ExternalLink className="h-4 w-4 mr-2" />
                Gerenciar Assinatura
              </Button>
            </form>
            <p className="text-xs text-muted-foreground mt-2 text-center">
              Atualizar cartao, ver faturas ou cancelar assinatura
            </p>
          </div>
        </CardContent>
      </Card>
    </div>
  )
}
```

**Create app/blocked/page.tsx:**

```typescript
import Link from "next/link"
import { Button } from "@/components/ui/button"
import { Card, CardContent, CardDescription, CardFooter, CardHeader, CardTitle } from "@/components/ui/card"
import { Heart } from "lucide-react"

export default function BlockedPage() {
  return (
    <div className="min-h-screen flex items-center justify-center bg-background p-4">
      <Card className="w-full max-w-md text-center">
        <CardHeader>
          <div className="mx-auto w-16 h-16 bg-primary/10 rounded-full flex items-center justify-center mb-4">
            <Heart className="h-8 w-8 text-primary" />
          </div>
          <CardTitle className="text-2xl">Sentimos sua falta!</CardTitle>
          <CardDescription>
            Sua assinatura expirou. Renove para continuar usando o Sincron Grupos.
          </CardDescription>
        </CardHeader>
        <CardContent>
          <p className="text-sm text-muted-foreground">
            Seus dados estao seguros e esperando por voce. Reative sua assinatura para
            retomar o controle dos seus grupos WhatsApp.
          </p>
        </CardContent>
        <CardFooter className="flex flex-col gap-3">
          <Button asChild className="w-full">
            <Link href="/checkout">Reativar Assinatura</Link>
          </Button>
          <Button asChild variant="ghost" className="w-full">
            <Link href="/">Voltar para o site</Link>
          </Button>
        </CardFooter>
      </Card>
    </div>
  )
}
```

**Update proxy.ts:**
Add /blocked to accessible routes and /api/webhooks to exclusions:

```typescript
// Add to public routes or handle separately
const publicRoutes = ['/', '/login', '/signup', '/checkout', '/blocked']
// ...
// Also ensure webhook route bypasses auth:
const isWebhookRoute = request.nextUrl.pathname.startsWith('/api/webhooks')
if (isWebhookRoute) {
  return supabaseResponse // Allow webhooks through
}
```

Create directory: `mkdir -p app/dashboard/billing app/blocked`
  </action>
  <verify>
1. `npm run build` succeeds
2. /dashboard/billing page renders subscription info
3. /blocked page renders friendly message
4. Customer Portal button present on billing page
  </verify>
  <done>
Billing page shows subscription status with portal access. Block screen created with friendly messaging.
  </done>
</task>

</tasks>

<verification>
1. `npm run build` succeeds
2. Dashboard shows trial badge when user is trialing
3. Dashboard shows grace badge when user is in grace period
4. Blocked users are redirected to /blocked page
5. Billing page at /dashboard/billing shows subscription status
6. Customer Portal button works (redirects to Stripe)
7. Block screen has "Reativar Assinatura" CTA
</verification>

<success_criteria>
- Trial users see "Trial: Xd" badge in dashboard header
- Grace period users see "Renove em Xd" warning badge
- /dashboard/billing displays subscription status (BILL-09)
- "Gerenciar Assinatura" links to Stripe Customer Portal (BILL-05, BILL-10)
- Blocked users see friendly screen with reactivate option (BILL-08)
- Portuguese copy throughout
</success_criteria>

<output>
After completion, create `.planning/phases/02-stripe-billing/02-05-SUMMARY.md`
</output>
