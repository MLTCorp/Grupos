---
phase: 02-stripe-billing
plan: 03
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - lib/actions/stripe.ts
  - app/(auth)/checkout/page.tsx
  - app/(auth)/signup/page.tsx
  - proxy.ts
autonomous: true

must_haves:
  truths:
    - "User is redirected to checkout page after successful signup"
    - "Checkout page shows plan selection with prices"
    - "Selecting a plan redirects to Stripe Checkout with 7-day trial"
    - "Successful checkout redirects to dashboard"
    - "Canceled checkout returns to checkout page with message"
  artifacts:
    - path: "lib/actions/stripe.ts"
      provides: "Server action for creating Stripe Checkout session"
      exports: ["createCheckoutSession"]
    - path: "app/(auth)/checkout/page.tsx"
      provides: "Plan selection page before Stripe redirect"
      min_lines: 80
  key_links:
    - from: "app/(auth)/signup/page.tsx"
      to: "/checkout"
      via: "router.push after signup"
      pattern: "router.push.*checkout"
    - from: "lib/actions/stripe.ts"
      to: "stripe.checkout.sessions.create"
      via: "Stripe SDK call"
      pattern: "checkout\\.sessions\\.create"
---

<objective>
Implement checkout flow where users select a plan and are redirected to Stripe Checkout after signup.

Purpose: Per CONTEXT.md decision, card is requested AFTER signup but BEFORE accessing dashboard. Users must complete Stripe Checkout with a 7-day trial to access the dashboard.

Output: Complete signup-to-checkout flow with plan selection and Stripe integration.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-stripe-billing/02-RESEARCH.md
@.planning/phases/02-stripe-billing/02-CONTEXT.md
@app/(auth)/signup/page.tsx
@lib/supabase/server.ts
@lib/stripe.ts (from 02-01)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Server Action for Stripe Checkout</name>
  <files>lib/actions/stripe.ts</files>
  <action>
Create server action that creates a Stripe Checkout session with trial:

```typescript
'use server'

import { redirect } from 'next/navigation'
import { createClient } from '@/lib/supabase/server'
import { stripe } from '@/lib/stripe'

export async function createCheckoutSession(priceId: string) {
  const supabase = await createClient()
  const { data: { user } } = await supabase.auth.getUser()

  if (!user) {
    throw new Error('Voce precisa estar logado para assinar')
  }

  // Check if customer already exists
  const { data: customer } = await supabase
    .from('customers')
    .select('stripe_customer_id')
    .eq('id', user.id)
    .single()

  const session = await stripe.checkout.sessions.create({
    mode: 'subscription',
    payment_method_collection: 'always', // Collect card upfront per CONTEXT.md
    line_items: [{ price: priceId, quantity: 1 }],
    subscription_data: {
      trial_period_days: 7,
      metadata: { user_id: user.id }
    },
    success_url: `${process.env.NEXT_PUBLIC_APP_URL}/dashboard?checkout=success`,
    cancel_url: `${process.env.NEXT_PUBLIC_APP_URL}/checkout?canceled=true`,
    customer: customer?.stripe_customer_id || undefined,
    customer_email: customer?.stripe_customer_id ? undefined : user.email,
    metadata: { user_id: user.id },
    locale: 'pt-BR',
    allow_promotion_codes: true,
  })

  redirect(session.url!)
}
```

Create the lib/actions directory if needed: `mkdir -p lib/actions`
  </action>
  <verify>
File exists at lib/actions/stripe.ts.
TypeScript compiles without errors.
  </verify>
  <done>
Server action created for Stripe Checkout session with 7-day trial.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create checkout page with plan selection</name>
  <files>app/(auth)/checkout/page.tsx</files>
  <action>
Create checkout page that shows plan options and handles Stripe redirect:

**Layout:**
- Header: "Escolha seu plano"
- Subheader: "Comece com 7 dias de trial gratuito"
- Two plan cards (Inicial, Profissional) - Enterprise is contact-only
- Each card shows: name, price, features, "Escolher" button
- If `?canceled=true` query param, show toast "Checkout cancelado"

**Plan cards:**
- Inicial: R$ 147/mes
  - 1 instancia WhatsApp
  - Ate 10 grupos
  - Features: Agendamento, Categorias, Historico
  - Button: "Escolher Inicial"

- Profissional: R$ 347/mes
  - 3 instancias WhatsApp
  - Ate 30 grupos
  - Features: Tudo do Inicial + Agente IA + Suporte prioritario
  - Button: "Escolher Profissional"

**Technical:**
- Use Card components from shadcn
- Each button calls createCheckoutSession(priceId) via form action
- Handle canceled state from query param
- Apply (auth) layout styling

**Price ID wiring (IMPORTANT):**
- Price IDs come from environment variables: `NEXT_PUBLIC_STRIPE_PRICE_INICIAL`, `NEXT_PUBLIC_STRIPE_PRICE_PROFISSIONAL`
- These are configured in .env.local after user creates Products/Prices in Stripe Dashboard (per 02-01 user_setup)
- The database `prices` table (from 02-01 migration) stores synced prices but is NOT used for checkout
- Rationale: Checkout uses env vars for simplicity and reliability; database prices are for display/reporting
- Implementation pattern:
```typescript
const PRICE_IDS = {
  inicial: process.env.NEXT_PUBLIC_STRIPE_PRICE_INICIAL!,
  profissional: process.env.NEXT_PUBLIC_STRIPE_PRICE_PROFISSIONAL!,
}
// Then in form: <input type="hidden" name="priceId" value={PRICE_IDS.inicial} />
```
- Add TODO comment if env var is missing: `// TODO: Configure NEXT_PUBLIC_STRIPE_PRICE_INICIAL in .env.local`

**Client component for interactivity:**
```typescript
'use client'

import { useSearchParams } from 'next/navigation'
import { useEffect } from 'react'
import { toast } from 'sonner'
// ... rest of component
```
  </action>
  <verify>
1. Run `npm run dev`
2. Navigate to /checkout
3. Two plan cards visible with correct info
4. Buttons present (will fail without Stripe price IDs, but UI renders)
  </verify>
  <done>
Checkout page renders with two plan options and selection buttons.
  </done>
</task>

<task type="auto">
  <name>Task 3: Update signup to redirect to checkout and update proxy</name>
  <files>app/(auth)/signup/page.tsx, proxy.ts</files>
  <action>
**Update signup page:**
After successful signup, redirect to /checkout instead of /login:

Change:
```typescript
toast.success("Conta criada! Verifique seu email para confirmar.")
router.push("/login")
```

To:
```typescript
toast.success("Conta criada! Escolha seu plano para continuar.")
router.push("/checkout")
```

**Update proxy.ts:**
Add /checkout to accessible routes. Users need to access checkout after signup but before having subscription.

Specific changes to make:

1. Update publicRoutes array:
```typescript
const publicRoutes = ['/', '/login', '/signup', '/checkout']
```

2. Update the auth redirect logic to allow authenticated users on /checkout:
```typescript
// After the publicRoutes check, add this BEFORE the dashboard protection:
// Allow authenticated users to access /checkout (they need to complete checkout)
if (user && request.nextUrl.pathname === '/checkout') {
  return supabaseResponse // Allow access, don't redirect to dashboard
}

if (user && (request.nextUrl.pathname === '/login' || request.nextUrl.pathname === '/signup')) {
  // Redirect to dashboard if already authenticated (unless on checkout)
  const url = request.nextUrl.clone()
  url.pathname = '/dashboard'
  return NextResponse.redirect(url)
}
```

The key insight: /checkout is both "public" (no auth required initially) AND accessible to authenticated users (they arrive after signup). The existing redirect-to-dashboard logic must skip /checkout.
  </action>
  <verify>
1. Run signup flow
2. After creating account, redirected to /checkout
3. /checkout is accessible for authenticated users without subscription
  </verify>
  <done>
Signup redirects to checkout. Proxy allows authenticated users to access checkout page.
  </done>
</task>

</tasks>

<verification>
1. `npm run build` succeeds
2. Signup flow redirects to /checkout after account creation
3. Checkout page shows two plans with correct prices
4. Selecting a plan attempts to create Stripe session (may fail without price IDs configured)
5. Canceled checkout shows appropriate message
</verification>

<success_criteria>
- Signup -> Checkout flow works end-to-end
- Checkout page displays Inicial and Profissional plans
- Plan selection triggers Stripe Checkout with 7-day trial
- Success URL points to dashboard, cancel URL returns to checkout
- Portuguese copy throughout
</success_criteria>

<output>
After completion, create `.planning/phases/02-stripe-billing/02-03-SUMMARY.md`
</output>
