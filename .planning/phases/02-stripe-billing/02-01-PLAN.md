---
phase: 02-stripe-billing
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - lib/stripe.ts
  - lib/stripe-client.ts
  - lib/supabase/service.ts
  - supabase/migrations/20260128000001_billing_schema.sql
autonomous: true
user_setup:
  - service: stripe
    why: "Payment processing and subscription management"
    env_vars:
      - name: STRIPE_SECRET_KEY
        source: "Stripe Dashboard -> Developers -> API keys -> Secret key"
      - name: NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY
        source: "Stripe Dashboard -> Developers -> API keys -> Publishable key"
      - name: STRIPE_WEBHOOK_SECRET
        source: "Stripe Dashboard -> Developers -> Webhooks -> Create endpoint -> Signing secret"
    dashboard_config:
      - task: "Create Products with Prices"
        location: "Stripe Dashboard -> Products"
        details: |
          Product 1: "Sincron Grupos - Inicial" - R$ 147/month (BRL), metadata: {plan: "inicial", instances: 1, groups: 10}
          Product 2: "Sincron Grupos - Profissional" - R$ 347/month (BRL), metadata: {plan: "profissional", instances: 3, groups: 30}
      - task: "Configure Customer Portal"
        location: "Stripe Dashboard -> Settings -> Billing -> Customer Portal"
        details: "Enable: Update payment method, Cancel subscription, View invoice history"

must_haves:
  truths:
    - "Stripe SDK initialized with proper API version"
    - "Database tables exist for customers, products, prices, subscriptions"
    - "Service client exists for admin database operations"
  artifacts:
    - path: "lib/stripe.ts"
      provides: "Server-side Stripe SDK initialization"
      exports: ["stripe"]
    - path: "lib/stripe-client.ts"
      provides: "Client-side Stripe.js loader"
      exports: ["getStripe"]
    - path: "lib/supabase/service.ts"
      provides: "Admin Supabase client for webhook operations"
      exports: ["createServiceClient"]
    - path: "supabase/migrations/20260128000001_billing_schema.sql"
      provides: "Database schema for billing"
      contains: "create table subscriptions"
  key_links:
    - from: "lib/stripe.ts"
      to: "process.env.STRIPE_SECRET_KEY"
      via: "SDK initialization"
      pattern: "STRIPE_SECRET_KEY"
---

<objective>
Set up Stripe SDK and database schema for billing infrastructure.

Purpose: Establish the foundation that all billing features depend on - SDK initialization, client-side loader, and database tables for tracking customers and subscriptions.

Output: Working Stripe SDK integration and database schema ready for checkout and webhook features.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-stripe-billing/02-RESEARCH.md
@lib/supabase/server.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Stripe SDK initialization files</name>
  <files>lib/stripe.ts, lib/stripe-client.ts</files>
  <action>
Create two files for Stripe integration:

**lib/stripe.ts** (server-side):
```typescript
import Stripe from 'stripe'

export const stripe = new Stripe(process.env.STRIPE_SECRET_KEY!, {
  apiVersion: '2025-01-27.acacia',
  typescript: true,
})
```

**lib/stripe-client.ts** (client-side):
```typescript
import { loadStripe, Stripe } from '@stripe/stripe-js'

let stripePromise: Promise<Stripe | null>

export const getStripe = () => {
  if (!stripePromise) {
    stripePromise = loadStripe(process.env.NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY!)
  }
  return stripePromise
}
```

Install required packages: `npm install stripe @stripe/stripe-js`
  </action>
  <verify>
Run `npm run build` - should compile without TypeScript errors.
Check that lib/stripe.ts and lib/stripe-client.ts exist.
  </verify>
  <done>
Stripe SDK files exist and compile without errors.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Supabase service client for admin operations</name>
  <files>lib/supabase/service.ts</files>
  <action>
Create a service client that uses the service role key for admin operations (used by webhooks to write subscription data):

```typescript
import { createClient } from '@supabase/supabase-js'

export function createServiceClient() {
  return createClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.SUPABASE_SERVICE_ROLE_KEY!,
    {
      auth: {
        autoRefreshToken: false,
        persistSession: false
      }
    }
  )
}
```

Note: This bypasses RLS. Only use for webhook handlers and admin operations.
  </action>
  <verify>
File exists at lib/supabase/service.ts.
TypeScript compiles without errors.
  </verify>
  <done>
Service client created for admin database operations.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create database migration for billing schema</name>
  <files>supabase/migrations/20260128000001_billing_schema.sql</files>
  <action>
Create migration file with billing tables. Follow the schema from RESEARCH.md:

```sql
-- Enum types
create type subscription_status as enum (
  'trialing',
  'active',
  'canceled',
  'incomplete',
  'incomplete_expired',
  'past_due',
  'unpaid',
  'paused'
);

create type pricing_type as enum ('one_time', 'recurring');
create type pricing_plan_interval as enum ('day', 'week', 'month', 'year');

-- Customers table (links auth.users to Stripe)
create table customers (
  id uuid references auth.users not null primary key,
  stripe_customer_id text unique,
  created_at timestamp with time zone default timezone('utc'::text, now()) not null
);
alter table customers enable row level security;
create policy "Users can view own customer data" on customers for select using (auth.uid() = id);

-- Products table (synced from Stripe)
create table products (
  id text primary key,
  active boolean,
  name text,
  description text,
  image text,
  metadata jsonb
);
alter table products enable row level security;
create policy "Allow public read-only access" on products for select using (true);

-- Prices table (synced from Stripe)
create table prices (
  id text primary key,
  product_id text references products,
  active boolean,
  description text,
  unit_amount bigint,
  currency text check (char_length(currency) = 3),
  type pricing_type,
  interval pricing_plan_interval,
  interval_count integer,
  trial_period_days integer,
  metadata jsonb
);
alter table prices enable row level security;
create policy "Allow public read-only access" on prices for select using (true);

-- Subscriptions table (synced from Stripe)
create table subscriptions (
  id text primary key,
  user_id uuid references auth.users not null,
  status subscription_status,
  metadata jsonb,
  price_id text references prices,
  quantity integer,
  cancel_at_period_end boolean,
  created timestamp with time zone default timezone('utc'::text, now()) not null,
  current_period_start timestamp with time zone default timezone('utc'::text, now()) not null,
  current_period_end timestamp with time zone default timezone('utc'::text, now()) not null,
  ended_at timestamp with time zone,
  cancel_at timestamp with time zone,
  canceled_at timestamp with time zone,
  trial_start timestamp with time zone,
  trial_end timestamp with time zone
);
alter table subscriptions enable row level security;
create policy "Users can view own subscription data" on subscriptions for select using (auth.uid() = user_id);

-- Index for faster subscription lookups
create index subscriptions_user_id_idx on subscriptions(user_id);
create index subscriptions_status_idx on subscriptions(status);
```

Create supabase directory if it doesn't exist: `mkdir -p supabase/migrations`
  </action>
  <verify>
File exists at supabase/migrations/20260128000001_billing_schema.sql.
SQL syntax is valid (no parse errors).
  </verify>
  <done>
Database migration file created with all billing tables (customers, products, prices, subscriptions).
  </done>
</task>

</tasks>

<verification>
1. `npm run build` completes without TypeScript errors
2. All four files exist:
   - lib/stripe.ts
   - lib/stripe-client.ts
   - lib/supabase/service.ts
   - supabase/migrations/20260128000001_billing_schema.sql
3. Migration file contains tables: customers, products, prices, subscriptions
</verification>

<success_criteria>
- Stripe SDK initializes (build succeeds)
- Database schema ready for deployment
- Service client available for webhook handlers
- All files have proper TypeScript types
</success_criteria>

<output>
After completion, create `.planning/phases/02-stripe-billing/02-01-SUMMARY.md`
</output>
