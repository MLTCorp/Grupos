---
phase: 03-dashboard-shell
plan: 03
type: execute
wave: 3
depends_on: ["03-02"]
files_modified:
  - components/onboarding/tour-provider.tsx
  - components/onboarding/use-onboarding.ts
  - app/dashboard/layout.tsx
  - app/globals.css
autonomous: false

must_haves:
  truths:
    - "New user without instances sees onboarding tour on dashboard"
    - "Tour highlights sidebar navigation explaining each section"
    - "Tour ends with Instancias item highlighted with shine effect"
    - "User can dismiss tour at any step"
    - "Tour shows again on next visit if user still has no instances"
  artifacts:
    - path: "components/onboarding/tour-provider.tsx"
      provides: "Driver.js tour configuration and trigger"
      contains: "driver"
    - path: "components/onboarding/use-onboarding.ts"
      provides: "Hook to check if onboarding needed"
      contains: "checkNeedsOnboarding"
    - path: "app/globals.css"
      provides: "Driver.js CSS overrides for theme"
      contains: "driver-popover"
  key_links:
    - from: "app/dashboard/layout.tsx"
      to: "components/onboarding/tour-provider.tsx"
      via: "renders TourProvider"
      pattern: "TourProvider"
    - from: "components/onboarding/tour-provider.tsx"
      to: "driver.js"
      via: "imports and configures driver"
      pattern: "driver.*drive"
---

<objective>
Implement interactive onboarding tour for new users using driver.js.

Purpose: Guides new users through the dashboard interface, explains navigation structure, and directs them to create their first WhatsApp instance.
Output: Tour system that triggers for users without instances, highlights sidebar items, ends with Instancias call-to-action.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/03-dashboard-shell/03-CONTEXT.md
@.planning/phases/03-dashboard-shell/03-RESEARCH.md
@app/dashboard/layout.tsx
@components/dashboard-nav.tsx
@components/app-sidebar.tsx
@lib/navigation.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install driver.js and Create Tour Infrastructure</name>
  <files>
    package.json
    components/onboarding/use-onboarding.ts
    components/onboarding/tour-provider.tsx
  </files>
  <action>
1. Install driver.js:
```bash
npm install driver.js
```

2. Create useOnboarding hook (components/onboarding/use-onboarding.ts):
```typescript
import { createClient } from '@/lib/supabase/client'

export async function checkNeedsOnboarding(userId: string): Promise<boolean> {
  const supabase = createClient()

  // Check if user has any instances
  const { count, error } = await supabase
    .from('instances')
    .select('*', { count: 'exact', head: true })
    .eq('user_id', userId)

  if (error) {
    console.error('[ONBOARDING] Error checking instances:', error)
    return false // Don't show tour on error
  }

  return count === 0
}
```

3. Create TourProvider component (components/onboarding/tour-provider.tsx):
- Client component
- Import driver.js and its CSS
- Accept userId and needsOnboarding props
- Use useEffect to start tour when needsOnboarding is true
- Configure driver with Portuguese text

Tour steps (from CONTEXT.md):
1. Welcome step (no element): "Bem-vindo ao Sincron Grupos!"
2. Sidebar overview (#sidebar-nav): "Este e seu menu de navegacao"
3. Instancias (#nav-instances): "Comece conectando sua primeira instancia do WhatsApp"
4. Categorias (#nav-categories): "Organize seus grupos em categorias"
5. Grupos (#nav-groups): "Visualize e gerencie seus grupos"
6. Mensagens (#nav-messages): "Envie mensagens para seus grupos"
7. Agente (#nav-agent): "Converse com o assistente de IA"
8. Final CTA: Highlight Instancias with shine effect, "Clique aqui para comecar!"

Driver.js configuration:
```typescript
const driverObj = driver({
  showProgress: true,
  showButtons: ['next', 'previous', 'close'],
  nextBtnText: 'Proximo',
  prevBtnText: 'Anterior',
  doneBtnText: 'Comecar!',
  progressText: '{{current}} de {{total}}',
  popoverClass: 'sincron-tour',
  steps: [
    {
      popover: {
        title: 'Bem-vindo ao Sincron Grupos!',
        description: 'Vamos conhecer as funcionalidades do sistema.',
      }
    },
    {
      element: '#nav-instances',
      popover: {
        title: 'Instancias',
        description: 'Conecte suas instancias do WhatsApp aqui. Este e o primeiro passo!',
        side: 'right',
      }
    },
    // ... more steps
  ],
  onDestroyStarted: () => {
    // Tour was dismissed or completed
    // Note: We don't persist "completed" - tour shows until user has instances
  }
})
```

Important: Wait for DOM elements to exist before starting tour. Use requestAnimationFrame or setTimeout(0) in useEffect.
  </action>
  <verify>
Dependencies and files:
- `grep "driver.js" package.json`
- Files exist: components/onboarding/tour-provider.tsx, components/onboarding/use-onboarding.ts
- `grep -l "checkNeedsOnboarding" components/onboarding/use-onboarding.ts`
- `grep -l "driver" components/onboarding/tour-provider.tsx`
  </verify>
  <done>
driver.js installed.
useOnboarding hook checks instances count.
TourProvider configures and runs tour with Portuguese text.
  </done>
</task>

<task type="auto">
  <name>Task 2: Style Tour for Dark/Light Theme</name>
  <files>
    app/globals.css
  </files>
  <action>
Add driver.js CSS overrides to globals.css for theme compatibility:

```css
/* Driver.js Tour Styling */
.driver-popover {
  background-color: hsl(var(--popover));
  color: hsl(var(--popover-foreground));
  border: 1px solid hsl(var(--border));
  border-radius: var(--radius);
  box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1);
}

.driver-popover .driver-popover-title {
  font-size: 1rem;
  font-weight: 600;
  color: hsl(var(--foreground));
}

.driver-popover .driver-popover-description {
  font-size: 0.875rem;
  color: hsl(var(--muted-foreground));
  margin-top: 0.5rem;
}

.driver-popover .driver-popover-progress-text {
  font-size: 0.75rem;
  color: hsl(var(--muted-foreground));
}

.driver-popover .driver-popover-navigation-btns {
  gap: 0.5rem;
}

.driver-popover .driver-popover-prev-btn,
.driver-popover .driver-popover-next-btn {
  background-color: hsl(var(--primary));
  color: hsl(var(--primary-foreground));
  border-radius: calc(var(--radius) - 2px);
  padding: 0.5rem 1rem;
  font-size: 0.875rem;
  font-weight: 500;
  border: none;
  cursor: pointer;
  transition: opacity 0.2s;
}

.driver-popover .driver-popover-prev-btn:hover,
.driver-popover .driver-popover-next-btn:hover {
  opacity: 0.9;
}

.driver-popover .driver-popover-prev-btn {
  background-color: hsl(var(--secondary));
  color: hsl(var(--secondary-foreground));
}

.driver-popover .driver-popover-close-btn {
  color: hsl(var(--muted-foreground));
}

.driver-popover .driver-popover-close-btn:hover {
  color: hsl(var(--foreground));
}

/* Highlight overlay */
.driver-overlay {
  background-color: hsl(var(--background) / 0.8);
}

/* Highlighted element */
.driver-active-element {
  box-shadow: 0 0 0 4px hsl(var(--primary) / 0.3);
}

/* Final step - Instancias highlight with animation */
.tour-final-highlight {
  animation: tour-pulse 2s ease-in-out infinite;
}

@keyframes tour-pulse {
  0%, 100% {
    box-shadow: 0 0 0 0 hsl(var(--primary) / 0.4);
  }
  50% {
    box-shadow: 0 0 0 8px hsl(var(--primary) / 0);
  }
}
```

The CSS variables (--popover, --primary, etc.) are already defined in globals.css and adapt to dark/light theme automatically.
  </action>
  <verify>
CSS added:
- `grep "driver-popover" app/globals.css`
- `grep "tour-final-highlight" app/globals.css`
  </verify>
  <done>
Driver.js styled to match shadcn/ui theme.
Tour adapts to dark/light mode automatically.
Final step has pulse animation for attention.
  </done>
</task>

<task type="auto">
  <name>Task 3: Integrate Tour into Dashboard Layout</name>
  <files>
    app/dashboard/layout.tsx
    components/onboarding/tour-provider.tsx
  </files>
  <action>
1. Update dashboard layout to check onboarding status and render TourProvider:

```tsx
import { TourProvider } from '@/components/onboarding/tour-provider'
import { checkNeedsOnboarding } from '@/components/onboarding/use-onboarding'

// Inside DashboardLayout, after auth and subscription checks:
const needsOnboarding = await checkNeedsOnboarding(user.id)

// In return, add TourProvider inside SidebarProvider:
return (
  <SidebarProvider>
    <AppSidebar ... />
    <SidebarInset>
      ...
    </SidebarInset>
    <BottomNav />
    <TourProvider userId={user.id} needsOnboarding={needsOnboarding} />
  </SidebarProvider>
)
```

2. Ensure nav items have correct IDs for tour targeting:
In components/dashboard-nav.tsx, each SidebarMenuItem should have:
- id={`nav-${item.href.split('/').pop()}`}

This creates IDs like: nav-instances, nav-categories, nav-groups, nav-messages, nav-agent

3. Update TourProvider to handle final step special behavior:
- On last step (Instancias), add class 'tour-final-highlight' to element
- Remove class on tour destroy
- Consider using ShineBorder component if available, otherwise CSS animation

4. Handle tour on mobile:
- Tour still works on mobile but targets bottom nav items instead
- Or skip tour on mobile (simpler) - detect with useIsMobile
- Decision: Skip tour on mobile (bottom nav is self-explanatory)

```tsx
// In TourProvider
const isMobile = useIsMobile()
useEffect(() => {
  if (isMobile || !needsOnboarding) return
  // Start tour...
}, [isMobile, needsOnboarding])
```
  </action>
  <verify>
Integration works:
- `npm run dev`
- Create new user (or user with no instances)
- Visit /dashboard
- Tour should start automatically
- Tour highlights nav items in sequence
- Tour can be dismissed
- Refresh page - tour shows again (no instances yet)
  </verify>
  <done>
TourProvider integrated into dashboard layout.
Tour triggers for users without instances.
Nav items have correct IDs for targeting.
Tour skips on mobile for simplicity.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete onboarding tour system:
- driver.js installed and configured
- Tour with 7 steps explaining dashboard navigation
- Portuguese text throughout
- Theme-aware styling (works in dark and light mode)
- Triggers for users without WhatsApp instances
- Skips on mobile
  </what-built>
  <how-to-verify>
1. Ensure you have a user with NO instances in the database
2. Run `npm run dev`
3. Visit http://localhost:3000/dashboard
4. Tour should start automatically with "Bem-vindo ao Sincron Grupos!"
5. Click "Proximo" through all steps
6. Verify each step highlights the correct nav item
7. Final step should highlight "Instancias" with pulsing effect
8. Click "Comecar!" to end tour
9. Refresh page - tour should appear again (still no instances)
10. Test in light mode: toggle theme, tour styling should adapt
11. Test dismiss: start tour, click X, tour closes
12. Resize to mobile width - tour should NOT appear (bottom nav visible instead)
  </how-to-verify>
  <resume-signal>Type "approved" if tour works correctly, or describe any issues</resume-signal>
</task>

</tasks>

<verification>
After all tasks complete:
1. `npm run build` passes
2. New user sees onboarding tour on dashboard
3. Tour explains all navigation items in Portuguese
4. Tour styling matches app theme (dark/light)
5. Tour shows until user has instances (not "shown once")
6. DASH-05 requirement satisfied
</verification>

<success_criteria>
- DASH-05: Onboarding guiado para usuarios novos (primeira instancia)
- Tour triggers based on instances count (not one-time flag)
- Portuguese localization for all tour text
- Theme-aware styling
- Mobile gracefully handled (skipped)
- Tour ends with clear CTA to Instancias
</success_criteria>

<output>
After completion, create `.planning/phases/03-dashboard-shell/03-03-SUMMARY.md`
</output>
