---
phase: 01-auth-foundation
plan: 03
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - middleware.ts
  - app/auth/callback/route.ts
  - app/dashboard/page.tsx
  - app/dashboard/layout.tsx
autonomous: false

must_haves:
  truths:
    - "Accessing /dashboard without login redirects to /login"
    - "Logged in user can access /dashboard and see welcome content"
    - "Logged in user accessing /login is redirected to /dashboard"
    - "User can log out and is redirected to home page"
    - "Email confirmation callback works and redirects to dashboard"
  artifacts:
    - path: "middleware.ts"
      provides: "Route protection via session check"
      contains: "updateSession"
    - path: "app/auth/callback/route.ts"
      provides: "Auth callback handler for email confirmation"
      exports: ["GET"]
    - path: "app/dashboard/page.tsx"
      provides: "Protected dashboard page"
      contains: "getUser"
    - path: "app/dashboard/layout.tsx"
      provides: "Dashboard layout with logout"
      min_lines: 10
  key_links:
    - from: "middleware.ts"
      to: "lib/supabase/middleware.ts"
      via: "updateSession import"
      pattern: "from.*lib/supabase/middleware"
    - from: "app/auth/callback/route.ts"
      to: "lib/supabase/server.ts"
      via: "createClient import"
      pattern: "from.*lib/supabase/server"
    - from: "app/dashboard/page.tsx"
      to: "lib/supabase/server.ts"
      via: "createClient for user fetch"
      pattern: "from.*lib/supabase/server"
---

<objective>
Implement route protection middleware, auth callback handler, and dashboard with logout functionality.

Purpose: Ensure only authenticated users can access /dashboard/* routes, handle email confirmation flow, and allow users to sign out.

Output:
- Middleware that protects /dashboard/* routes
- Auth callback route for email confirmation
- Dashboard page that shows user info and logout button
- Complete auth flow: signup -> email confirm -> login -> dashboard -> logout
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-auth-foundation/01-CONTEXT.md
@.planning/phases/01-auth-foundation/01-01-SUMMARY.md

**Route protection decisions from CONTEXT:**
- Middleware Supabase para proteger /dashboard/*
- Redirect para /login se nao autenticado
- Sessao persiste via cookies Supabase
- Public routes: /, /login, /signup, /auth/callback

**Logout flow:**
- User can log out from any dashboard page
- After logout, redirect to home (/)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create middleware for route protection</name>
  <files>middleware.ts</files>
  <action>
    Create root middleware.ts that:
    1. Imports updateSession from lib/supabase/middleware
    2. Calls updateSession to refresh auth cookies
    3. Checks user authentication status
    4. Redirects unauthenticated users from protected routes to /login
    5. Redirects authenticated users from /login, /signup to /dashboard
    6. Allows access to public routes

    **Public routes:**
    - / (landing)
    - /login
    - /signup
    - /auth/callback
    - /auth/confirm

    **Protected routes:**
    - /dashboard and all subroutes (/dashboard/*)

    **Full middleware code:**
    ```typescript
    import { createServerClient } from '@supabase/ssr'
    import { NextResponse, type NextRequest } from 'next/server'

    export async function middleware(request: NextRequest) {
      let supabaseResponse = NextResponse.next({
        request,
      })

      const supabase = createServerClient(
        process.env.NEXT_PUBLIC_SUPABASE_URL!,
        process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,
        {
          cookies: {
            getAll() {
              return request.cookies.getAll()
            },
            setAll(cookiesToSet) {
              cookiesToSet.forEach(({ name, value }) => request.cookies.set(name, value))
              supabaseResponse = NextResponse.next({
                request,
              })
              cookiesToSet.forEach(({ name, value, options }) =>
                supabaseResponse.cookies.set(name, value, options)
              )
            },
          },
        }
      )

      // Do not run code between createServerClient and getUser
      const {
        data: { user },
      } = await supabase.auth.getUser()

      // Public routes that don't require authentication
      const publicRoutes = ['/', '/login', '/signup']
      const isPublicRoute = publicRoutes.includes(request.nextUrl.pathname) ||
        request.nextUrl.pathname.startsWith('/auth/')

      // Protected routes that require authentication
      const isProtectedRoute = request.nextUrl.pathname.startsWith('/dashboard')

      if (!user && isProtectedRoute) {
        // Redirect to login if not authenticated
        const url = request.nextUrl.clone()
        url.pathname = '/login'
        return NextResponse.redirect(url)
      }

      if (user && (request.nextUrl.pathname === '/login' || request.nextUrl.pathname === '/signup')) {
        // Redirect to dashboard if already authenticated
        const url = request.nextUrl.clone()
        url.pathname = '/dashboard'
        return NextResponse.redirect(url)
      }

      return supabaseResponse
    }

    export const config = {
      matcher: [
        /*
         * Match all request paths except for:
         * - _next/static (static files)
         * - _next/image (image optimization files)
         * - favicon.ico (favicon file)
         * - public files (images, etc.)
         */
        '/((?!_next/static|_next/image|favicon.ico|.*\\.(?:svg|png|jpg|jpeg|gif|webp)$).*)',
      ],
    }
    ```
  </action>
  <verify>
    Check that middleware.ts exists at project root.
    TypeScript should compile without errors.
  </verify>
  <done>
    - middleware.ts exists at project root
    - Imports Supabase server client
    - Has matcher config excluding static files
    - Checks user auth via getUser()
    - Redirects unauthenticated from /dashboard to /login
    - Redirects authenticated from /login,/signup to /dashboard
  </done>
</task>

<task type="auto">
  <name>Task 2: Create auth callback route</name>
  <files>app/auth/callback/route.ts</files>
  <action>
    Create auth callback route handler for email confirmation flow:

    **How it works:**
    1. User signs up and receives email with confirmation link
    2. Link contains ?code=xxx parameter
    3. This route exchanges code for session
    4. Redirects to /dashboard on success, /login?error=... on failure

    **Full route code:**
    ```typescript
    import { createClient } from '@/lib/supabase/server'
    import { NextResponse } from 'next/server'

    export async function GET(request: Request) {
      const { searchParams, origin } = new URL(request.url)
      const code = searchParams.get('code')
      const next = searchParams.get('next') ?? '/dashboard'

      if (code) {
        const supabase = await createClient()
        const { error } = await supabase.auth.exchangeCodeForSession(code)

        if (!error) {
          return NextResponse.redirect(`${origin}${next}`)
        }
      }

      // Redirect to login with error if something went wrong
      return NextResponse.redirect(`${origin}/login?error=auth_callback_error`)
    }
    ```

    Create app/auth/callback directory if it doesn't exist.
  </action>
  <verify>
    Check that app/auth/callback/route.ts exists.
    TypeScript should compile without errors.
  </verify>
  <done>
    - app/auth/callback/route.ts exists
    - Exports GET handler
    - Exchanges code for session via Supabase
    - Redirects to /dashboard on success
    - Redirects to /login?error=... on failure
  </done>
</task>

<task type="auto">
  <name>Task 3: Update dashboard page with user info and logout</name>
  <files>
    app/dashboard/page.tsx
    app/dashboard/layout.tsx
  </files>
  <action>
    Update dashboard to:
    1. Fetch current user from Supabase
    2. Display welcome message with user email
    3. Provide logout functionality

    **app/dashboard/layout.tsx:**
    Create a layout that wraps dashboard pages. For now, simple container with logout button:

    ```tsx
    import { createClient } from "@/lib/supabase/server"
    import { redirect } from "next/navigation"
    import { LogoutButton } from "./logout-button"

    export default async function DashboardLayout({
      children,
    }: {
      children: React.ReactNode
    }) {
      const supabase = await createClient()
      const { data: { user } } = await supabase.auth.getUser()

      if (!user) {
        redirect("/login")
      }

      return (
        <div className="min-h-screen bg-background">
          <header className="border-b">
            <div className="container flex h-16 items-center justify-between px-4">
              <div className="flex items-center gap-2">
                <div className="w-8 h-8 bg-primary rounded-lg flex items-center justify-center">
                  <span className="text-primary-foreground font-bold text-sm">SG</span>
                </div>
                <span className="font-semibold">Sincron Grupos</span>
              </div>
              <div className="flex items-center gap-4">
                <span className="text-sm text-muted-foreground">{user.email}</span>
                <LogoutButton />
              </div>
            </div>
          </header>
          <main className="container py-6 px-4">
            {children}
          </main>
        </div>
      )
    }
    ```

    **app/dashboard/logout-button.tsx:**
    Create client component for logout:

    ```tsx
    "use client"

    import { createClient } from "@/lib/supabase/client"
    import { useRouter } from "next/navigation"
    import { Button } from "@/components/ui/button"
    import { LogOut } from "lucide-react"

    export function LogoutButton() {
      const router = useRouter()

      const handleLogout = async () => {
        const supabase = createClient()
        await supabase.auth.signOut()
        router.push("/")
      }

      return (
        <Button variant="ghost" size="sm" onClick={handleLogout}>
          <LogOut className="h-4 w-4 mr-2" />
          Sair
        </Button>
      )
    }
    ```

    **app/dashboard/page.tsx:**
    Update to show welcome content (minimal for now, Phase 3 builds real dashboard):

    ```tsx
    import { createClient } from "@/lib/supabase/server"
    import { Card, CardContent, CardDescription, CardHeader, CardTitle } from "@/components/ui/card"

    export default async function DashboardPage() {
      const supabase = await createClient()
      const { data: { user } } = await supabase.auth.getUser()

      const userName = user?.user_metadata?.name || user?.email?.split("@")[0] || "Usuario"

      return (
        <div className="space-y-6">
          <div>
            <h1 className="text-3xl font-bold">Ola, {userName}!</h1>
            <p className="text-muted-foreground">
              Bem-vindo ao Sincron Grupos
            </p>
          </div>

          <div className="grid gap-4 md:grid-cols-3">
            <Card>
              <CardHeader>
                <CardTitle>Instancias</CardTitle>
                <CardDescription>Conecte seu WhatsApp</CardDescription>
              </CardHeader>
              <CardContent>
                <p className="text-2xl font-bold">0</p>
                <p className="text-xs text-muted-foreground">instancias conectadas</p>
              </CardContent>
            </Card>

            <Card>
              <CardHeader>
                <CardTitle>Grupos</CardTitle>
                <CardDescription>Gerencie seus grupos</CardDescription>
              </CardHeader>
              <CardContent>
                <p className="text-2xl font-bold">0</p>
                <p className="text-xs text-muted-foreground">grupos importados</p>
              </CardContent>
            </Card>

            <Card>
              <CardHeader>
                <CardTitle>Mensagens</CardTitle>
                <CardDescription>Envie e agende</CardDescription>
              </CardHeader>
              <CardContent>
                <p className="text-2xl font-bold">0</p>
                <p className="text-xs text-muted-foreground">mensagens enviadas</p>
              </CardContent>
            </Card>
          </div>

          <Card>
            <CardHeader>
              <CardTitle>Proximo Passo</CardTitle>
              <CardDescription>Configure sua primeira instancia WhatsApp</CardDescription>
            </CardHeader>
            <CardContent>
              <p className="text-sm text-muted-foreground">
                Para comecar, voce precisa conectar uma instancia do UAZAPI.
                Esta funcionalidade estara disponivel em breve.
              </p>
            </CardContent>
          </Card>
        </div>
      )
    }
    ```

    **Important:** Also create the logout-button.tsx file as shown above.
  </action>
  <verify>
    1. Visit /dashboard without being logged in - should redirect to /login
    2. Log in and visit /dashboard - should see welcome message and logout button
    3. Click logout button - should redirect to home page
  </verify>
  <done>
    - Dashboard layout shows header with logo, user email, logout button
    - Dashboard page shows welcome message with user name
    - Dashboard shows placeholder cards for Instances, Groups, Messages
    - Logout button signs out user and redirects to /
    - Unauthenticated access redirects to /login
  </done>
</task>

</tasks>

<verification>
Full auth flow test:

1. **Route Protection Test:**
   - Open incognito browser, visit /dashboard
   - Should redirect to /login
   - Visit /login, /signup - pages should load

2. **Login Flow Test:**
   - Visit /login
   - Enter valid credentials (if Supabase configured)
   - Should redirect to /dashboard
   - Should see welcome message and email in header

3. **Redirect Authenticated User Test:**
   - While logged in, visit /login or /signup
   - Should redirect to /dashboard

4. **Logout Flow Test:**
   - On dashboard, click "Sair" button
   - Should redirect to home page (/)
   - Try accessing /dashboard again
   - Should redirect to /login

5. **Session Persistence Test:**
   - Log in, close browser tab
   - Open new tab, visit /dashboard
   - Should still be logged in (session persists)
</verification>

<success_criteria>
- Middleware protects /dashboard/* routes
- Unauthenticated users redirected from /dashboard to /login
- Authenticated users redirected from /login,/signup to /dashboard
- Auth callback route handles email confirmation
- Dashboard shows user info (name/email)
- Logout button works and redirects to /
- Session persists across page refreshes
- No TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/01-auth-foundation/01-03-SUMMARY.md`
</output>
