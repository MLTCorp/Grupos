---
phase: 04-instances-mcp-foundation
plan: 03
type: execute
wave: 3
depends_on: ["04-02"]
files_modified:
  - app/dashboard/instances/page.tsx
  - lib/hooks/use-polling.ts
  - components/instances/disconnect-banner.tsx
autonomous: false

must_haves:
  truths:
    - "User can navigate to /dashboard/instances and see instance list"
    - "Status updates automatically every 30 seconds"
    - "Connection success triggers automatic webhook configuration"
    - "Disconnection shows persistent banner"
  artifacts:
    - path: "app/dashboard/instances/page.tsx"
      provides: "Instances management page"
      min_lines: 100
    - path: "lib/hooks/use-polling.ts"
      provides: "Reusable polling hook"
      exports: ["usePolling"]
  key_links:
    - from: "app/dashboard/instances/page.tsx"
      to: "components/instances"
      via: "imports"
      pattern: "from.*components/instances"
    - from: "app/dashboard/instances/page.tsx"
      to: "/api/uazapi/instances/[token]/webhook"
      via: "auto-config on connect"
      pattern: "webhook"
---

<objective>
Create the instances page with polling for real-time status updates and automatic webhook configuration.

Purpose: Deliver the complete instance management experience with real-time status updates via polling, automatic webhook configuration on first connection, and proper disconnect handling.

Output: Fully functional /dashboard/instances page with 30-second polling, auto-webhook configuration, disconnect banner, and integration of all instance components.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-instances-mcp-foundation/04-CONTEXT.md
@.planning/phases/04-instances-mcp-foundation/04-RESEARCH.md
@.planning/phases/04-instances-mcp-foundation/04-01-SUMMARY.md
@.planning/phases/04-instances-mcp-foundation/04-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create usePolling Hook</name>
  <files>lib/hooks/use-polling.ts</files>
  <action>
Create reusable polling hook for status checking.

```typescript
interface UsePollingOptions {
  interval: number        // ms between polls (default 30000)
  enabled?: boolean       // whether polling is active
  onError?: (error: Error) => void
}

export function usePolling<T>(
  fetcher: () => Promise<T>,
  options: UsePollingOptions
): {
  data: T | null
  isLoading: boolean
  error: Error | null
  refetch: () => Promise<void>
}
```

Implementation requirements:
- Use useEffect with cleanup (clearInterval)
- Use useCallback for fetcher to avoid stale closures
- Pause when tab not visible (document.hidden check)
- Resume when tab becomes visible
- Immediate fetch on mount, then interval
- Handle component unmount cleanly
- Expose refetch for manual trigger

Per RESEARCH.md pitfall: "Always return cleanup function from useEffect"
  </action>
  <verify>Hook compiles and can be imported without errors</verify>
  <done>usePolling hook exported from lib/hooks/use-polling.ts</done>
</task>

<task type="auto">
  <name>Task 2: Create Disconnect Banner Component</name>
  <files>components/instances/disconnect-banner.tsx</files>
  <action>
Create persistent banner that appears when any instance is unexpectedly disconnected.

Per CONTEXT.md: "Desconexao inesperada: toast + card atualiza + banner persistente"

Props:
```typescript
interface DisconnectBannerProps {
  disconnectedInstances: Instance[]
  onReconnect: (instance: Instance) => void
  onDismiss: () => void
}
```

Structure:
- Fixed position at top of page (below header)
- Yellow/amber background for warning
- Message: "X instancia(s) desconectada(s)"
- List of disconnected instance names
- "Reconectar" button for each
- Dismiss button (hides until next disconnect)

Only shows if there are disconnected instances that were previously connected (track previous status in parent).

Use Alert component from shadcn with warning variant.
Icons: AlertTriangle for warning, RefreshCw for reconnect.
  </action>
  <verify>Component renders correctly with mock disconnected instances</verify>
  <done>DisconnectBanner shows warning for unexpectedly disconnected instances</done>
</task>

<task type="auto">
  <name>Task 3: Create Instances Page</name>
  <files>app/dashboard/instances/page.tsx</files>
  <action>
Create the main instances management page.

Page structure:
1. Header with title "Instancias WhatsApp" and Add button
2. DisconnectBanner (if any unexpected disconnections)
3. InstanceList with all instances
4. QRCodeModal (controlled by state)
5. AddInstanceDialog (controlled by state)
6. DeleteInstanceDialog (controlled by state)

State management:
```typescript
const [instances, setInstances] = useState<Instance[]>([])
const [selectedInstance, setSelectedInstance] = useState<Instance | null>(null)
const [qrModalOpen, setQrModalOpen] = useState(false)
const [addDialogOpen, setAddDialogOpen] = useState(false)
const [deleteDialogOpen, setDeleteDialogOpen] = useState(false)
const [previousStatuses, setPreviousStatuses] = useState<Map<number, string>>()
```

Data fetching:
- Initial load: GET /api/instances
- Polling: For each instance, check status via /api/uazapi/instances/[token]/status
- Use usePolling hook with 30s interval

Auto-webhook configuration (CRITICAL):
```typescript
// When status changes to 'conectado' AND webhook_url is null
if (newStatus === 'conectado' && !instance.webhook_url) {
  try {
    await fetch(`/api/uazapi/instances/${instance.api_key}/webhook`, { method: 'POST' })
    // Update local state to reflect webhook_url is now set
  } catch (err) {
    console.error('Webhook config failed:', err)
    // Non-blocking - don't fail the connection flow
  }
}
```

Status change detection:
- Compare current status with previousStatuses
- If was 'conectado' and now 'desconectado', add to disconnected list for banner
- Update previousStatuses after each poll

Event handlers:
- onConnect: Open QR modal for instance
- onDisconnect: Call POST /api/uazapi/instances/[token] with { action: 'disconnect' }
- onDelete: Open delete confirmation dialog
- onStatusChange: Update instance in list, check for webhook config

Auto-retry per CONTEXT.md: "Auto-retry: 3 tentativas antes de marcar como falha"
- Track retry count per instance
- On error, retry up to 3 times with exponential backoff
- After 3 failures, show error state on card

Use showSuccess/showError from lib/toast for feedback.
  </action>
  <verify>Page loads at /dashboard/instances, shows instance list</verify>
  <done>Instances page with polling, auto-webhook, and full interaction flow</done>
</task>

<task type="auto">
  <name>Task 4: Integration and Error Handling</name>
  <files>app/dashboard/instances/page.tsx</files>
  <action>
Add comprehensive error handling and edge cases.

Error scenarios to handle:
1. Failed to load instances: Show error state with retry button
2. Failed to check status: Show inline error on card with retry button
3. Failed to connect (QR): Show error in modal, auto-retry QR generation
4. Failed to disconnect: Show toast error, revert optimistic update
5. Failed to delete: Show toast error
6. Failed to configure webhook: Log error, don't block flow

Loading states:
- Page loading: Skeleton cards
- Individual status check: Subtle loading indicator on card
- QR generation: Spinner in modal
- Action in progress: Disabled buttons with spinner

Per CONTEXT.md error handling:
- "Erro de API: mensagem inline no card com botao retry"
- "Mensagens de erro sempre amigaveis/traduzidas"

Error messages (Portuguese):
- "Nao foi possivel carregar as instancias. Tente novamente."
- "Erro ao verificar status. Clique para tentar novamente."
- "Falha ao conectar. O QR code sera regenerado automaticamente."
- "Erro ao desconectar instancia."
- "Erro ao excluir instancia."

Empty state:
- When no instances: "Nenhuma instancia configurada. Adicione sua primeira instancia para comecar."
- Button: "Adicionar Instancia"
  </action>
  <verify>Error states display correctly, retry buttons work</verify>
  <done>Comprehensive error handling with Portuguese messages and retry logic</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete WhatsApp instance management interface:
- Instance list with status badges (card layout)
- QR code connection modal with auto-regeneration
- Connection history in collapsible dropdown
- Add instance dialog
- Delete confirmation with name typing
- 30-second status polling
- Automatic webhook configuration on first connection
- Disconnect banner for unexpected disconnections
  </what-built>
  <how-to-verify>
1. Navigate to http://localhost:3000/dashboard/instances
2. Verify empty state shows with "Adicionar Instancia" button
3. Click Add, enter a name, verify instance is created
4. Click Connect on the new instance, verify QR modal opens
5. (If you have UAZAPI configured) Scan QR with WhatsApp
6. Verify status changes to "Conectado" with green badge
7. Verify phone number appears on card
8. Expand history dropdown, verify "connected" event logged
9. Wait 30+ seconds, verify status still shows correctly (polling)
10. Test disconnect and verify banner appears
11. Test delete with name confirmation

Note: Full testing requires UAZAPI environment variables configured.
Without UAZAPI, verify UI components render correctly and error states show appropriately.
  </how-to-verify>
  <resume-signal>Type "approved" to continue, or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
1. TypeScript compilation passes: `npx tsc --noEmit`
2. Page accessible at /dashboard/instances
3. Polling hook works with 30s interval
4. Auto-webhook triggers on first connection
5. Disconnect banner appears for unexpected disconnections
6. All error states handled with Portuguese messages
</verification>

<success_criteria>
- /dashboard/instances page loads and displays instances
- Status polling updates every 30 seconds
- QR modal opens and displays QR code (or error if UAZAPI not configured)
- Connection triggers automatic webhook configuration
- Disconnect banner appears for unexpected disconnections
- All components integrate correctly
- Error handling is comprehensive
- Human verification checkpoint passed
</success_criteria>

<output>
After completion, create `.planning/phases/04-instances-mcp-foundation/04-03-SUMMARY.md`
</output>
