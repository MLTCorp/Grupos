---
phase: 04-instances-mcp-foundation
plan: 04
type: execute
wave: 1
depends_on: []
files_modified:
  - app/api/mcp/route.ts
  - lib/mcp/tools.ts
  - lib/mcp/auth.ts
autonomous: true

must_haves:
  truths:
    - "GET /api/mcp returns tool list with valid x-api-key"
    - "GET /api/mcp returns 401 without valid auth"
    - "Tools include get_instance_status and configure_webhook"
  artifacts:
    - path: "app/api/mcp/route.ts"
      provides: "MCP discovery endpoint"
      exports: ["GET"]
    - path: "lib/mcp/tools.ts"
      provides: "MCP tool definitions"
      contains: "get_instance_status"
    - path: "lib/mcp/auth.ts"
      provides: "API key validation"
      exports: ["isValidApiKey", "getApiKeyFromHeaders"]
  key_links:
    - from: "app/api/mcp/route.ts"
      to: "lib/mcp/auth.ts"
      via: "API key validation"
      pattern: "isValidApiKey"
    - from: "app/api/mcp/route.ts"
      to: "lib/mcp/tools.ts"
      via: "tool definitions"
      pattern: "from.*lib/mcp/tools"
---

<objective>
Create MCP discovery endpoint with API key authentication and tool definitions.

Purpose: Establish the Model Context Protocol (MCP) foundation by creating a discovery endpoint that lists available tools for AI agents, secured with API key authentication.

Output: /api/mcp endpoint that returns tool definitions when authenticated with x-api-key header, supporting the MCP protocol for AI tool discovery.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-instances-mcp-foundation/04-CONTEXT.md
@.planning/phases/04-instances-mcp-foundation/04-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create API Key Authentication</name>
  <files>lib/mcp/auth.ts</files>
  <action>
Create API key validation utilities for MCP endpoint authentication.

```typescript
// lib/mcp/auth.ts

/**
 * Extract API key from request headers
 * Supports: x-api-key header (MCP-13 requirement)
 */
export function getApiKeyFromHeaders(headers: Headers): string | null {
  return headers.get('x-api-key')
}

/**
 * Validate API key against stored keys
 * For now: Check against MCP_API_KEY environment variable
 * Future: Could validate against per-organization keys in database
 */
export async function isValidApiKey(apiKey: string): Promise<boolean> {
  const validKey = process.env.MCP_API_KEY
  if (!validKey) {
    console.warn('MCP_API_KEY not configured')
    return false
  }
  return apiKey === validKey
}

/**
 * Get organization ID from API key (future use)
 * For now returns null - all valid keys have same access
 */
export async function getOrgIdFromApiKey(apiKey: string): Promise<number | null> {
  // Future: Query database for org associated with this key
  return null
}
```

Note: MCP_API_KEY is a simple shared secret for now. Future phases may implement per-organization API keys stored in the organizacoes table.
  </action>
  <verify>File compiles: `npx tsc --noEmit lib/mcp/auth.ts`</verify>
  <done>API key validation utilities exported from lib/mcp/auth.ts</done>
</task>

<task type="auto">
  <name>Task 2: Create MCP Tool Definitions</name>
  <files>lib/mcp/tools.ts</files>
  <action>
Create MCP tool definitions following the Model Context Protocol specification.

```typescript
// lib/mcp/tools.ts

/**
 * MCP Tool Definition following modelcontextprotocol.io spec
 */
export interface MCPTool {
  name: string
  description: string
  inputSchema: {
    type: 'object'
    properties: Record<string, {
      type: string
      description: string
      enum?: string[]
    }>
    required?: string[]
  }
}

/**
 * Phase 4 MCP Tools (MCP-01, MCP-07)
 * Additional tools will be added in later phases
 */
export const mcpTools: MCPTool[] = [
  {
    name: 'get_instance_status',
    description: 'Obtem status atual da instancia WhatsApp incluindo conexao, numero de telefone e informacoes do perfil',
    inputSchema: {
      type: 'object',
      properties: {
        instance_id: {
          type: 'string',
          description: 'ID da instancia WhatsApp (numero do ID na tabela instancias_whatsapp)'
        }
      },
      required: ['instance_id']
    }
  },
  {
    name: 'configure_webhook',
    description: 'Configura webhook N8N para uma instancia WhatsApp. Usado para habilitar o recebimento de mensagens e eventos.',
    inputSchema: {
      type: 'object',
      properties: {
        instance_id: {
          type: 'string',
          description: 'ID da instancia WhatsApp'
        }
      },
      required: ['instance_id']
    }
  }
]

/**
 * Get all available tools
 * Future: Could filter by organization permissions
 */
export function getAvailableTools(): MCPTool[] {
  return mcpTools
}

/**
 * Get tool by name
 */
export function getToolByName(name: string): MCPTool | undefined {
  return mcpTools.find(t => t.name === name)
}
```

Note: These are discovery definitions only. Actual tool execution will be implemented in later phases when we add /api/mcp/execute endpoint.
  </action>
  <verify>File compiles and exports tools array: `npx tsc --noEmit lib/mcp/tools.ts`</verify>
  <done>MCP tool definitions for get_instance_status and configure_webhook</done>
</task>

<task type="auto">
  <name>Task 3: Create MCP Discovery Endpoint</name>
  <files>app/api/mcp/route.ts</files>
  <action>
Create the MCP discovery endpoint per MCP-12 and MCP-13 requirements.

```typescript
// app/api/mcp/route.ts
import { NextRequest, NextResponse } from 'next/server'
import { getApiKeyFromHeaders, isValidApiKey } from '@/lib/mcp/auth'
import { getAvailableTools } from '@/lib/mcp/tools'

/**
 * GET /api/mcp - MCP Discovery Endpoint
 *
 * Returns list of available MCP tools.
 * Requires x-api-key header for authentication (MCP-13).
 *
 * Response format follows MCP protocol:
 * {
 *   tools: MCPTool[]
 * }
 */
export async function GET(request: NextRequest) {
  // Extract and validate API key
  const apiKey = getApiKeyFromHeaders(request.headers)

  if (!apiKey) {
    return NextResponse.json(
      { error: 'API key required', code: 'MISSING_API_KEY' },
      { status: 401 }
    )
  }

  const isValid = await isValidApiKey(apiKey)
  if (!isValid) {
    return NextResponse.json(
      { error: 'Invalid API key', code: 'INVALID_API_KEY' },
      { status: 401 }
    )
  }

  // Return available tools
  const tools = getAvailableTools()

  return NextResponse.json({
    tools,
    _meta: {
      version: '1.0',
      protocol: 'mcp',
      toolCount: tools.length
    }
  })
}
```

Response structure:
- 200: { tools: MCPTool[], _meta: { version, protocol, toolCount } }
- 401: { error: string, code: 'MISSING_API_KEY' | 'INVALID_API_KEY' }

Note: POST /api/mcp/execute for tool execution will be added in a later phase when we implement the actual tool handlers.
  </action>
  <verify>
Endpoint responds correctly:
- Without key: `curl http://localhost:3000/api/mcp` returns 401
- With valid key: `curl -H "x-api-key: $MCP_API_KEY" http://localhost:3000/api/mcp` returns tools
  </verify>
  <done>MCP discovery endpoint at /api/mcp with API key authentication</done>
</task>

</tasks>

<verification>
1. TypeScript compilation passes: `npx tsc --noEmit`
2. API route exists at app/api/mcp/route.ts
3. Request without x-api-key returns 401
4. Request with invalid key returns 401
5. Request with valid MCP_API_KEY returns tool list
6. Tool list includes get_instance_status and configure_webhook
</verification>

<success_criteria>
- lib/mcp/auth.ts exports isValidApiKey and getApiKeyFromHeaders
- lib/mcp/tools.ts exports mcpTools array with 2 tools
- app/api/mcp/route.ts handles GET requests with proper auth
- Unauthenticated requests return 401
- Authenticated requests return tool definitions
- Response includes _meta with version info
</success_criteria>

<output>
After completion, create `.planning/phases/04-instances-mcp-foundation/04-04-SUMMARY.md`
</output>
