---
phase: 04-instances-mcp-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - lib/uazapi/types.ts
  - lib/uazapi/service.ts
  - lib/uazapi/index.ts
  - app/api/uazapi/instances/route.ts
  - app/api/uazapi/instances/[token]/route.ts
  - app/api/uazapi/instances/[token]/status/route.ts
  - app/api/uazapi/instances/[token]/connect/route.ts
  - app/api/uazapi/instances/[token]/webhook/route.ts
autonomous: true
user_setup:
  - service: uazapi
    why: "WhatsApp API integration"
    env_vars:
      - name: UAZAPI_BASE_URL
        source: "UAZAPI dashboard - your subdomain URL (e.g., https://yourname.uazapi.com)"
      - name: UAZAPI_API_KEY
        source: "UAZAPI dashboard - Admin Token (admintoken for instance management)"
      - name: WEBHOOK_N8N_URL
        source: "N8N workflow webhook URL for receiving WhatsApp events"

must_haves:
  truths:
    - "API routes proxy calls to UAZAPI correctly"
    - "Token validation returns status information"
    - "Webhook configuration updates database"
  artifacts:
    - path: "lib/uazapi/types.ts"
      provides: "TypeScript interfaces for UAZAPI"
      contains: "InstanciaWhatsApp"
    - path: "lib/uazapi/service.ts"
      provides: "UAZAPI client service"
      exports: ["UAZAPIService", "getUAZAPIService"]
    - path: "app/api/uazapi/instances/route.ts"
      provides: "Instance creation endpoint"
      exports: ["POST"]
    - path: "app/api/uazapi/instances/[token]/status/route.ts"
      provides: "Status check endpoint"
      exports: ["GET"]
  key_links:
    - from: "lib/uazapi/service.ts"
      to: "/api/uazapi/instances"
      via: "fetch calls"
      pattern: "this.baseUrl"
    - from: "app/api/uazapi/instances/[token]/webhook/route.ts"
      to: "instancias_whatsapp"
      via: "supabase update"
      pattern: "from.*instancias_whatsapp"
---

<objective>
Port UAZAPI service layer from original project and create all API routes for WhatsApp instance management.

Purpose: Establish the foundation for all WhatsApp instance operations by creating type-safe service layer and Next.js API routes that proxy calls to UAZAPI.

Output: Complete UAZAPI integration layer with types, service class, and API routes for instance creation, status checking, QR code connection, webhook configuration, and disconnection.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-instances-mcp-foundation/04-CONTEXT.md
@.planning/phases/04-instances-mcp-foundation/04-RESEARCH.md
@.claude/skills/uazapi-whatsapp-skill/SKILL.md
@uazapi-openapi-spec.yaml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create UAZAPI Types</name>
  <files>lib/uazapi/types.ts, lib/uazapi/index.ts</files>
  <action>
Create TypeScript interfaces for UAZAPI integration. Port from the existing types in the current project (lib/uazapi/types.ts already exists - verify and enhance if needed).

Key types to include:
- InstanciaWhatsApp: Instance data from UAZAPI
- InstanciaStatusCompleto: Extracted status with phone, profile info
- UAZAPIResponse: Standard response structure
- UAZAPIStatusResponse: Status endpoint response with extractedStatus
- WebhookConfig: Webhook configuration payload
- ConnectionWebhookPayload: Webhook event for connection changes
- STATUS_LABELS and STATUS_COLORS: Portuguese mappings for UI

Create index.ts to re-export all types and service.

Reference: The current project already has lib/uazapi/types.ts - verify it matches UAZAPI OpenAPI spec and add any missing types.
  </action>
  <verify>TypeScript compiles without errors: `npx tsc --noEmit lib/uazapi/types.ts`</verify>
  <done>All UAZAPI types defined and exported from lib/uazapi/index.ts</done>
</task>

<task type="auto">
  <name>Task 2: Create UAZAPI Service Class</name>
  <files>lib/uazapi/service.ts</files>
  <action>
Create singleton service class that provides client-side methods to call our API routes (NOT direct UAZAPI calls - those go through our API routes for security).

```typescript
export class UAZAPIService {
  private baseUrl = '/api/uazapi'

  async obterStatus(instanceToken: string): Promise<UAZAPIStatusResponse>
  async conectar(instanceToken: string, phone?: string): Promise<ConnectResponse>
  async desconectar(instanceToken: string): Promise<void>
  async configurarWebhook(instanceToken: string): Promise<WebhookResponse>
}

let serviceInstance: UAZAPIService | null = null
export function getUAZAPIService(): UAZAPIService {
  if (!serviceInstance) serviceInstance = new UAZAPIService()
  return serviceInstance
}
```

Methods should:
- Call our internal API routes (NOT UAZAPI directly)
- Handle errors gracefully with typed responses
- Return typed data matching our interfaces
  </action>
  <verify>Service class instantiates without errors in a test import</verify>
  <done>UAZAPIService class exported with all required methods</done>
</task>

<task type="auto">
  <name>Task 3: Create UAZAPI API Routes</name>
  <files>
    app/api/uazapi/instances/route.ts
    app/api/uazapi/instances/[token]/route.ts
    app/api/uazapi/instances/[token]/status/route.ts
    app/api/uazapi/instances/[token]/connect/route.ts
    app/api/uazapi/instances/[token]/webhook/route.ts
  </files>
  <action>
Create Next.js API routes that proxy calls to UAZAPI. These routes:
1. Read UAZAPI credentials from environment (UAZAPI_BASE_URL, UAZAPI_API_KEY)
2. Make server-side fetch calls to UAZAPI
3. Process responses (extract phone from JID, normalize status)
4. Update Supabase when relevant (webhook_url after config)

**app/api/uazapi/instances/route.ts (POST):**
- Create new instance via UAZAPI /instance/init
- Requires admintoken header
- Body: { name, systemName, adminField01? }

**app/api/uazapi/instances/[token]/route.ts (POST for disconnect, DELETE for remove):**
- POST with body { action: 'disconnect' } calls /instance/disconnect
- DELETE calls /instance/delete with admintoken

**app/api/uazapi/instances/[token]/status/route.ts (GET):**
- Call UAZAPI /instance/status
- Extract phone number from JID (handle both string and object JID)
- Format phone for display (+55 11 99999-9999)
- Return enriched response with extractedStatus

**app/api/uazapi/instances/[token]/connect/route.ts (POST):**
- Call UAZAPI /instance/connect
- Optional body: { phone?: string }
- Return QR code base64 from response

**app/api/uazapi/instances/[token]/webhook/route.ts (POST):**
- Configure webhook in UAZAPI with WEBHOOK_N8N_URL
- Events: ["messages", "connection", "groups"]
- excludeMessages: ["wasSentByApi"] (CRITICAL - prevents loops)
- addUrlEvents: true
- After success, update instancias_whatsapp.webhook_url in Supabase

Use createClient from lib/supabase/server for database operations.
Handle SSL issues in dev with https.Agent({ rejectUnauthorized: false }).
  </action>
  <verify>
All routes exist and TypeScript compiles:
- `ls app/api/uazapi/instances/`
- `npx tsc --noEmit`
  </verify>
  <done>
All 5 API routes created:
- POST /api/uazapi/instances (create)
- POST/DELETE /api/uazapi/instances/[token] (disconnect/delete)
- GET /api/uazapi/instances/[token]/status
- POST /api/uazapi/instances/[token]/connect
- POST /api/uazapi/instances/[token]/webhook
  </done>
</task>

</tasks>

<verification>
1. TypeScript compilation passes: `npx tsc --noEmit`
2. All API route files exist in correct locations
3. Service class can be imported without errors
4. Types are properly exported from lib/uazapi/index.ts
</verification>

<success_criteria>
- lib/uazapi/ contains types.ts, service.ts, index.ts
- app/api/uazapi/instances/ contains all 5 route files
- All files compile without TypeScript errors
- Service methods match API route endpoints
- Webhook route includes Supabase update logic
</success_criteria>

<output>
After completion, create `.planning/phases/04-instances-mcp-foundation/04-01-SUMMARY.md`
</output>
