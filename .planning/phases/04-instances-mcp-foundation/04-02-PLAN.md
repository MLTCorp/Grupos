---
phase: 04-instances-mcp-foundation
plan: 02
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - app/api/instances/route.ts
  - app/api/instances/[id]/route.ts
  - app/api/instances/[id]/history/route.ts
  - components/instances/instance-card.tsx
  - components/instances/instance-list.tsx
  - components/instances/instance-history.tsx
  - components/instances/qr-code-modal.tsx
  - components/instances/add-instance-dialog.tsx
  - components/instances/delete-instance-dialog.tsx
autonomous: true

must_haves:
  truths:
    - "User can see list of instances as cards"
    - "User can expand card to see connection history"
    - "QR code modal displays for connection"
    - "Delete confirmation requires typing instance name"
  artifacts:
    - path: "app/api/instances/route.ts"
      provides: "Internal instance CRUD"
      exports: ["GET", "POST"]
    - path: "components/instances/instance-card.tsx"
      provides: "Single instance card with status badge"
      contains: "Badge"
    - path: "components/instances/qr-code-modal.tsx"
      provides: "QR code connection modal"
      contains: "Sheet"
    - path: "components/instances/instance-history.tsx"
      provides: "Collapsible history dropdown"
      contains: "Collapsible"
  key_links:
    - from: "components/instances/instance-card.tsx"
      to: "/api/instances"
      via: "fetch for CRUD"
      pattern: "fetch.*api/instances"
    - from: "components/instances/qr-code-modal.tsx"
      to: "/api/uazapi/instances/[token]/connect"
      via: "fetch for QR"
      pattern: "api/uazapi.*connect"
---

<objective>
Create internal instance CRUD API and all UI components for WhatsApp instance management.

Purpose: Build the data layer (internal API talking to Supabase) and presentation layer (card-based UI components) for instance management.

Output: Internal API routes for instance CRUD with history logging, and shadcn-based UI components for displaying instances as cards with status badges, QR code modal, history dropdown, and add/delete dialogs.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-instances-mcp-foundation/04-CONTEXT.md
@.planning/phases/04-instances-mcp-foundation/04-RESEARCH.md
@.planning/phases/04-instances-mcp-foundation/04-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Internal Instances API</name>
  <files>
    app/api/instances/route.ts
    app/api/instances/[id]/route.ts
    app/api/instances/[id]/history/route.ts
  </files>
  <action>
Create internal API routes for instance CRUD operations against Supabase instancias_whatsapp table.

**app/api/instances/route.ts:**
- GET: List instances for current user's organization
  - Join with usuarios_sistema to get org_id from authenticated user
  - Return instances with current status
- POST: Create new instance
  - Validate name (3-50 chars)
  - Get api_key from UAZAPI via /api/uazapi/instances (create instance there first)
  - Insert into instancias_whatsapp with org_id
  - Log creation event to history

**app/api/instances/[id]/route.ts:**
- GET: Get single instance details
- DELETE: Delete instance
  - First delete from UAZAPI via /api/uazapi/instances/[token]
  - Then delete from Supabase
  - Log deletion event to history before delete

**app/api/instances/[id]/history/route.ts:**
- GET: Return last 5 connection events for instance
- POST: Add new history event
  - event_type: 'connected' | 'disconnected' | 'created' | 'deleted' | 'error'
  - timestamp, details (optional JSON)

History table structure (create if not exists - use Supabase SQL or check existing schema):
```sql
CREATE TABLE IF NOT EXISTS historico_conexoes (
  id BIGSERIAL PRIMARY KEY,
  instancia_id BIGINT REFERENCES instancias_whatsapp(id) ON DELETE CASCADE,
  event_type TEXT NOT NULL,
  details JSONB,
  created_at TIMESTAMPTZ DEFAULT NOW()
);
CREATE INDEX idx_historico_instancia ON historico_conexoes(instancia_id, created_at DESC);
```

Use createClient from lib/supabase/server for all database operations.
Verify user belongs to same organization as instance before any operation.
  </action>
  <verify>
All routes exist and TypeScript compiles:
- `ls app/api/instances/`
- `npx tsc --noEmit`
  </verify>
  <done>
Internal API routes created:
- GET/POST /api/instances
- GET/DELETE /api/instances/[id]
- GET/POST /api/instances/[id]/history
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Instance Card Component</name>
  <files>components/instances/instance-card.tsx</files>
  <action>
Create card component for displaying a single WhatsApp instance.

Structure per CONTEXT.md:
- Card header: instance name + status badge (green "Conectado" / red "Desconectado" / yellow "Conectando")
- Card content: connected phone number (formatted), last activity timestamp
- Card actions: Connect button (if disconnected), Disconnect button (if connected), Delete button
- Collapsible section for history (uses InstanceHistory component)

Props:
```typescript
interface InstanceCardProps {
  instance: {
    id: number
    nome_instancia: string
    api_key: string
    status: 'conectado' | 'desconectado' | 'conectando'
    numero_telefone?: string
    webhook_url?: string
    updated_at: string
  }
  onConnect: (instance: Instance) => void
  onDisconnect: (instance: Instance) => void
  onDelete: (instance: Instance) => void
  onStatusChange?: (instance: Instance, newStatus: string) => void
}
```

Use shadcn components:
- Card, CardHeader, CardTitle, CardContent, CardFooter
- Badge with variant based on status (default=green, secondary=red, outline=yellow)
- Button for actions
- Collapsible, CollapsibleTrigger, CollapsibleContent for history

Icons from lucide-react:
- Smartphone for connected phone
- Clock for last activity
- QrCode for connect action
- Power for disconnect
- Trash2 for delete
- ChevronDown for collapsible trigger
  </action>
  <verify>Component imports correctly and renders without errors in isolation</verify>
  <done>InstanceCard component displays instance info with status badge and action buttons</done>
</task>

<task type="auto">
  <name>Task 3: Create QR Code Modal and History Components</name>
  <files>
    components/instances/qr-code-modal.tsx
    components/instances/instance-history.tsx
    components/instances/instance-list.tsx
  </files>
  <action>
**components/instances/qr-code-modal.tsx:**
Create modal for QR code display during connection.

Per CONTEXT.md:
- Modal opens over instance list (use Sheet component)
- Shows QR code image (base64 from UAZAPI) + "Escaneie com WhatsApp" text
- Spinner while waiting for scan
- Auto-regenerates QR when expired (2 min timeout)
- Closes automatically on successful connection
- Shows countdown timer for QR expiration

Props:
```typescript
interface QRCodeModalProps {
  open: boolean
  onOpenChange: (open: boolean) => void
  instance: Instance
  onConnected: () => void
}
```

Use Sheet from shadcn, Next.js Image for QR display.
QR code comes from /api/uazapi/instances/[token]/connect response.

**components/instances/instance-history.tsx:**
Display last 5 connection events in collapsible dropdown.

Props:
```typescript
interface InstanceHistoryProps {
  instanceId: number
  expanded?: boolean
}
```

Fetch from /api/instances/[id]/history on mount.
Display events with:
- Event type icon (CheckCircle=connected, XCircle=disconnected, Plus=created)
- Timestamp (relative: "2 horas atras")
- Optional details

Use Collapsible components from shadcn.

**components/instances/instance-list.tsx:**
Grid layout for instance cards.

```typescript
interface InstanceListProps {
  instances: Instance[]
  onConnect: (instance: Instance) => void
  onDisconnect: (instance: Instance) => void
  onDelete: (instance: Instance) => void
  onStatusChange?: (instance: Instance, newStatus: string) => void
}
```

Responsive grid: 1 col mobile, 2 cols md, 3 cols lg.
Empty state with message and add button when no instances.
  </action>
  <verify>Components render without errors, QR modal opens/closes correctly</verify>
  <done>QR code modal, history dropdown, and instance list components created</done>
</task>

<task type="auto">
  <name>Task 4: Create Add and Delete Instance Dialogs</name>
  <files>
    components/instances/add-instance-dialog.tsx
    components/instances/delete-instance-dialog.tsx
  </files>
  <action>
**components/instances/add-instance-dialog.tsx:**
Dialog for creating new instance.

Fields:
- Nome da instancia (required, 3-50 chars)

Per CONTEXT.md: Token is invisible to user (SaaS model) - system generates it.

Props:
```typescript
interface AddInstanceDialogProps {
  open: boolean
  onOpenChange: (open: boolean) => void
  onSuccess: (instance: Instance) => void
}
```

On submit:
1. POST to /api/instances with { nome_instancia }
2. Show loading state
3. On success: close dialog, call onSuccess
4. On error: show error message (inline, not toast)

Check instance limit from user's billing plan before showing form.
If at limit, show upgrade message instead of form.

Use Dialog, DialogContent, DialogHeader, DialogTitle, DialogFooter from shadcn.
Use Input for name field, Button for actions.

**components/instances/delete-instance-dialog.tsx:**
Confirmation dialog requiring user to type instance name.

Per CONTEXT.md: "Exclusao requer modal de confirmacao com digitacao do nome da instancia"

Props:
```typescript
interface DeleteInstanceDialogProps {
  open: boolean
  onOpenChange: (open: boolean) => void
  instance: Instance
  onConfirm: () => void
}
```

Structure:
- Warning message explaining deletion is permanent
- Input field requiring exact instance name match
- Delete button disabled until name matches exactly
- Cancel button

Use AlertDialog components from shadcn for destructive action pattern.
Red styling for delete button.
  </action>
  <verify>Dialogs open/close correctly, validation works as expected</verify>
  <done>Add and delete dialogs with proper validation and confirmation flow</done>
</task>

</tasks>

<verification>
1. TypeScript compilation passes: `npx tsc --noEmit`
2. All component files exist in components/instances/
3. All API route files exist in app/api/instances/
4. Components use correct shadcn imports (Card, Badge, Sheet, Dialog, Collapsible)
5. Internal API routes connect to Supabase correctly
</verification>

<success_criteria>
- app/api/instances/ contains route.ts, [id]/route.ts, [id]/history/route.ts
- components/instances/ contains all 6 component files
- Card displays status with colored badge
- QR modal shows QR code with auto-refresh logic
- History shows last 5 events in collapsible
- Delete requires typing instance name to confirm
- All files compile without TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/04-instances-mcp-foundation/04-02-SUMMARY.md`
</output>
